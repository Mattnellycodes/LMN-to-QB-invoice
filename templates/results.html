{% extends "base.html" %}

{% block title %}Invoice Preview{% endblock %}

{% block content %}
<h1>Invoice Preview</h1>

{% if result.lmn_mapping_count %}
<div class="flash success" style="margin-bottom: 15px;">
    Loaded {{ result.lmn_mapping_count }} customer mappings from LMN
</div>
{% endif %}

{% if result.skipped_jobsites %}
<div class="flash warning">
    <strong>{{ result.skipped_jobsites|length }} jobsite(s) skipped</strong> - no QBO customer mapping
</div>
{% endif %}

{% if result.duplicates %}
<div class="flash warning">
    <strong>Warning: {{ result.duplicates|length }} timesheet(s) already invoiced</strong>
    <details style="margin-top: 10px;">
        <summary style="cursor: pointer;">View details</summary>
        <table style="margin-top: 10px; font-size: 0.9em;">
            <thead>
                <tr><th>Customer</th><th>Timesheet</th><th>Invoice #</th><th>Created</th></tr>
            </thead>
            <tbody>
                {% for dup in result.duplicates %}
                <tr>
                    <td>{{ dup.customer_name }}</td>
                    <td>{{ dup.timesheet_id }}</td>
                    <td>{{ dup.qbo_invoice_number }}</td>
                    <td>{{ dup.created_at[:10] if dup.created_at else '-' }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </details>
</div>
{% endif %}

<h2>Summary</h2>
<table>
    <tr>
        <th>Total Invoices</th>
        <td>{{ result.invoices|length }}</td>
    </tr>
    <tr>
        <th>Total Amount</th>
        <td class="text-right">${{ "%.2f"|format(result.total_amount) }}</td>
    </tr>
</table>

{% if result.invoices %}
<details class="mt-20" open>
    <summary style="cursor: pointer; font-weight: 500; font-size: 1.1em;">Customer Mapping Verification</summary>
    <p style="margin: 10px 0; color: #666;">Confirm LMN customers are mapped to the correct QuickBooks customers:</p>
    <table style="margin-bottom: 20px;">
        <thead>
            <tr>
                <th>LMN Customer</th>
                <th>→</th>
                <th>QuickBooks Customer</th>
                <th>QBO ID</th>
            </tr>
        </thead>
        <tbody>
            {% for invoice in result.invoices %}
            <tr>
                <td>{{ invoice.customer_name }}</td>
                <td style="text-align: center;">→</td>
                <td style="color: {% if invoice.qbo_display_name %}#28a745{% else %}#dc3545{% endif %};">
                    {{ invoice.qbo_display_name or '(NOT MAPPED)' }}
                </td>
                <td>{{ invoice.qbo_customer_id or '-' }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</details>

<h2 class="mt-20">Invoices to Create</h2>

<table>
    <thead>
        <tr>
            <th>Customer</th>
            <th>Jobsite</th>
            <th>Line Items</th>
            <th class="text-right">Subtotal</th>
            <th class="text-right">Fee</th>
            <th class="text-right">Total</th>
        </tr>
    </thead>
    <tbody>
        {% for invoice in result.invoices %}
        <tr>
            <td>{{ invoice.qbo_display_name or invoice.customer_name }}</td>
            <td>{{ invoice.jobsite_name }}</td>
            <td>{{ invoice.line_items|length }}</td>
            <td class="text-right">${{ "%.2f"|format(invoice.subtotal) }}</td>
            <td class="text-right">${{ "%.2f"|format(invoice.direct_payment_fee) }}</td>
            <td class="text-right"><strong>${{ "%.2f"|format(invoice.total) }}</strong></td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<details class="mt-20">
    <summary style="cursor: pointer; font-weight: 500;">View Line Item Details</summary>
    {% for invoice in result.invoices %}
    <div style="margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 8px;">
        <h4>{{ invoice.qbo_display_name or invoice.customer_name }} - {{ invoice.jobsite_name }}</h4>
        <table>
            <thead>
                <tr>
                    <th>Description</th>
                    <th class="text-right">Qty</th>
                    <th class="text-right">Rate</th>
                    <th class="text-right">Amount</th>
                </tr>
            </thead>
            <tbody>
                {% for item in invoice.line_items %}
                <tr>
                    <td>{{ item.description }}</td>
                    <td class="text-right">{{ "%.2f"|format(item.quantity) }}</td>
                    <td class="text-right">${{ "%.2f"|format(item.rate) }}</td>
                    <td class="text-right">${{ "%.2f"|format(item.amount) }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endfor %}
</details>

<form action="{{ url_for('create_invoices') }}" method="post" class="mt-20">
    {% if result.duplicate_jobsite_ids %}
    <div style="margin-bottom: 15px; padding: 10px; background: #fff3cd; border-radius: 4px;">
        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
            <input type="checkbox" name="skip_duplicates" value="1" checked>
            <span>Skip {{ result.duplicate_jobsite_ids|length }} jobsite(s) with already-invoiced timesheets</span>
        </label>
    </div>
    {% endif %}
    <button type="submit" class="btn btn-success">Create Draft Invoices in QuickBooks</button>
    <a href="{{ url_for('upload') }}" class="btn btn-secondary" style="margin-left: 10px;">Start Over</a>
</form>

{% else %}
<div class="flash warning">
    No invoices to create. All jobsites may have been skipped or have no billable items.
</div>
<a href="{{ url_for('upload') }}" class="btn">Upload New Files</a>
{% endif %}
{% endblock %}
